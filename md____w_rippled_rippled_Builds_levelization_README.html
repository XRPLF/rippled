<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rippled: Levelization</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">rippled
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Levelization </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Levelization is the term used to describe efforts to prevent rippled from having or creating cyclic dependencies.</p>
<p >rippled code is organized into directories under <code>src/rippled</code> (and <code>src/test</code>) representing modules. The modules are intended to be organized into "tiers" or "levels" such that a module from one level can only include code from lower levels. Additionally, a module in one level should never include code in an <code>impl</code> folder of any level other than it's own.</p>
<p >Unfortunately, over time, enforcement of levelization has been inconsistent, so the current state of the code doesn't necessarily reflect these rules. Whenever possible, developers should refactor any levelization violations they find (by moving files or individual classes). At the very least, don't make things worse.</p>
<p >The table below summarizes the <em>desired</em> division of modules, based on the state of the rippled code when it was created. The levels are numbered from the bottom up with the lower level, lower numbered, more independent modules listed first, and the higher level, higher numbered modules with more dependencies listed later.</p>
<p ><b>tl;dr:</b> The modules listed first are more independent than the modules listed later.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Level / Tier   </th><th class="markdownTableHeadNone">Module(s)    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">01   </td><td class="markdownTableBodyNone">ripple/beast ripple/unity    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">02   </td><td class="markdownTableBodyNone">ripple/basics    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">03   </td><td class="markdownTableBodyNone">ripple/json ripple/crypto    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">04   </td><td class="markdownTableBodyNone">ripple/protocol    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">05   </td><td class="markdownTableBodyNone">ripple/core ripple/conditions ripple/consensus ripple/resource ripple/server    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">06   </td><td class="markdownTableBodyNone">ripple/peerfinder ripple/ledger ripple/nodestore ripple/net    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">07   </td><td class="markdownTableBodyNone">ripple/shamap ripple/overlay    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">08   </td><td class="markdownTableBodyNone">ripple/app    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">09   </td><td class="markdownTableBodyNone">ripple/rpc    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">10   </td><td class="markdownTableBodyNone">ripple/perflog    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">11   </td><td class="markdownTableBodyNone">test/jtx test/beast test/csf    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">12   </td><td class="markdownTableBodyNone">test/unit_test    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">13   </td><td class="markdownTableBodyNone">test/crypto test/conditions test/json test/resource test/shamap test/peerfinder test/basics test/overlay    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">14   </td><td class="markdownTableBodyNone">test    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">15   </td><td class="markdownTableBodyNone">test/net test/protocol test/ledger test/consensus test/core test/server test/nodestore    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">16   </td><td class="markdownTableBodyNone">test/rpc test/app   </td></tr>
</table>
<p >(Note that <code>test</code> levelization is <em>much</em> less important and <em>much</em> less strictly enforced than <code>ripple</code> levelization, other than the requirement that <code>test</code> code should <em>never</em> be included in <code>ripple</code> code.)</p>
<h1><a class="anchor" id="autotoc_md41"></a>
Validation</h1>
<p >The <a href="levelization.sh">levelization.sh</a> script takes no parameters, reads no environment variables, and can be run from any directory, as long as it is in the expected location in the rippled repo. It can be run at any time from within a checked out repo, and will do an analysis of all the <code>#include</code>s in the rippled source. The only caveat is that it runs much slower under Windows than in Linux. It hasn't yet been tested under MacOS. It generates many files of [results](results):</p>
<ul>
<li><code>rawincludes.txt</code>: The raw dump of the <code>#includes</code></li>
<li><code>paths.txt</code>: A second dump grouping the source module to the destination module, deduped, and with frequency counts.</li>
<li><code>includes/</code>: A directory where each file represents a module and contains a list of modules and counts that the module <em>includes</em>.</li>
<li><code>includedby/</code>: Similar to <code>includes/</code>, but the other way around. Each file represents a module and contains a list of modules and counts that <em>include</em> the module.</li>
<li><a href="results/loops.txt"><code>loops.txt</code></a>: A list of direct loops detected between modules as they actually exist, as opposed to how they are desired as described above. In a perfect repo, this file will be empty. This file is committed to the repo, and is used by the <a href="../../.github/workflows/levelization.yml">levelization Github workflow</a> to validate that nothing changed.</li>
<li><a href="results/ordering.txt"><code>ordering.txt</code></a>: A list showing relationships between modules where there are no loops as they actually exist, as opposed to how they are desired as described above. This file is committed to the repo, and is used by the <a href="../../.github/workflows/levelization.yml">levelization Github workflow</a> to validate that nothing changed.</li>
<li><a href="../../.github/workflows/levelization.yml"><code>levelization.yml</code></a> Github Actions workflow to test that levelization loops haven't changed. Unfortunately, if changes are detected, it can't tell if they are improvements or not, so if you have resolved any issues or done anything else to improve levelization, run <code>levelization.sh</code>, and commit the updated results.</li>
</ul>
<p >The <code>loops.txt</code> and <code>ordering.txt</code> files relate the modules using comparison signs, which indicate the number of times each module is included in the other.</p>
<ul>
<li><code>A &gt; B</code> means that A should probably be at a higher level than B, because B is included in A significantly more than A is included in B. These results can be included in both <code>loops.txt</code> and <code>ordering.txt</code>. Because <code>ordering.txt</code>only includes relationships where B is not included in A at all, it will only include these types of results.</li>
<li><code>A ~= B</code> means that A and B are included in each other a different number of times, but the values are so close that the script can't definitively say that one should be above the other. These results will only be included in <code>loops.txt</code>.</li>
<li><code>A == B</code> means that A and B include each other the same number of times, so the script has no clue which should be higher. These results will only be included in <code>loops.txt</code>.</li>
</ul>
<p >The committed files hide the detailed values intentionally, to prevent false alarms and merging issues, and because it's easy to get those details locally.</p>
<ol type="1">
<li>Run <code>levelization.sh</code></li>
<li>Grep the modules in <code>paths.txt</code>.<ul>
<li>For example, if a cycle is found <code>A ~= B</code>, simply <code>grep -w A Builds/levelization/results/paths.txt | grep -w B</code> </li>
</ul>
</li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
