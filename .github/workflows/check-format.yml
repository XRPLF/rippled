# This workflow checks if the code is properly formatted.
name: Check format

# This workflow can only be triggered by other workflows.
on: workflow_call

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-format
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    container: ghcr.io/xrplf/ci/tools-rippled-pre-commit
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - name: Prepare runner
        uses: XRPLF/actions/.github/actions/prepare-runner@638e0dc11ea230f91bd26622fb542116bb5254d5
      - name: Format code
        run: pre-commit run --show-diff-on-failure --color=always --all-files
      - name: Check for differences
        env:
          MESSAGE: |
            One or more files did not conform to the formatting. Maybe you did
            not run 'pre-commit' before committing, or your version of
            'clang-format' or 'prettier' has an incompatibility with the ones
            used here (see the "Check configuration" step above).

            Run 'pre-commit run --all-files' in your repo, and then commit and
            push the changes.
        run: |
          DIFF=$(git status --porcelain)
          if [ -n "${DIFF}" ]; then
            # Print the files that changed to give the contributor a hint about
            # what to expect when running pre-commit on their own machine.
            git status
            echo "${MESSAGE}"
            exit 1
          fi
