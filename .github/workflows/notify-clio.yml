# This workflow exports the built libxrpl package to the Conan remote on a
# a channel named after the pull request, and notifies the Clio repository about
# the new version so it can check for compatibility.
name: Notify Clio

# This workflow can only be triggered by other workflows.
on:
  workflow_call:
    secrets:
      clio_notify_token:
        description: 'The GitHub token to notify Clio about new versions.'
        required: true
      conan_remote_username:
        description: 'The username for logging into the Conan remote.'
        required: true
      conan_remote_password:
        description: 'The password for logging into the Conan remote.'
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-clio
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  CONAN_REMOTE_NAME: xrplf
  CONAN_REMOTE_URL: https://conan.ripplex.io

jobs:
  upload:
    runs-on: ubuntu-latest
    container: ghcr.io/xrplf/ci/ubuntu-noble:gcc-13
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Generate outputs
        id: generate
        run: |
          echo "Generating channel."
          echo channel="clio/pr_${{ github.event.pull_request.number }}" >> "${GITHUB_OUTPUT}"
          echo "Extracting version."
          echo version="$(cat src/libxrpl/protocol/BuildInfo.cpp | grep "versionString =" | awk -F '"' '{print $2}')" >> "${GITHUB_OUTPUT}"
      - name: Add Conan remote
        run: |
          echo "Adding Conan remote '${{ env.CONAN_REMOTE_NAME }}' at ${{ env.CONAN_REMOTE_URL }}."
          conan remote add --index 0 --force ${{ env.CONAN_REMOTE_NAME }} ${{ env.CONAN_REMOTE_URL }}
          echo "Listing Conan remotes."
          conan remote list
      - name: Log into Conan remote
        run: conan remote login ${{ env.CONAN_REMOTE_NAME }} "${{ secrets.conan_remote_username }}" --password "${{ secrets.conan_remote_password }}"
      - name: Upload package
        run: |
          echo "Exporting package to channel ${{ steps.generate.outputs.channel }}"
          conan export --channel=${{ steps.generate.outputs.channel }} .
          echo "Uploading package version ${{ steps.generate.outputs.version }} on channel ${{ steps.generate.outputs.channel }}"
          conan upload --confirm --check --remote=${{ env.CONAN_REMOTE_NAME }} xrpl/${{ steps.generate.outputs.version }}@${{ steps.generate.outputs.channel }}
    outputs:
      channel: ${{ steps.generate.outputs.channel }}
      version: ${{ steps.generate.outputs.version }}

  notify:
    needs: upload
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.clio_notify_token }}
    steps:
      - name: Notify Clio
        run: |
          gh api --method POST -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/xrplf/clio/dispatches -f "event_type=check_libxrpl" \
          -F "client_payload[version]=${{ needs.upload.outputs.version }}@${{ needs.upload.outputs.channel }}" \
          -F "client_payload[pr]=${{ github.event.pull_request.number }}"
