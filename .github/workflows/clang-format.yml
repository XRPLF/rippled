name: clang-format

on: [push, pull_request]

jobs:
  check:
    runs-on: ubuntu-18.04
    env:
      CLANG_VERSION: 10
    steps:
    - uses: actions/checkout@v2
    - name: Install clang-format
      run: |
        sudo tee /etc/apt/sources.list.d/llvm.list >/dev/null <<EOF
        deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-${CLANG_VERSION} main
        deb-src http://apt.llvm.org/bionic/ llvm-toolchain-bionic-${CLANG_VERSION} main
        EOF
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add
        sudo apt-get update
        sudo apt-get install clang-format-${CLANG_VERSION}
    - name: Format src/ripple
      run: find src/ripple -type f \( -name '*.cpp' -o -name '*.h' -o -name '*.ipp' \) -print0 | xargs -0 clang-format-${CLANG_VERSION} -i
    - name: Format src/test
      run: find src/test -type f \( -name '*.cpp' -o -name '*.h' -o -name '*.ipp' \) -print0 | xargs -0 clang-format-${CLANG_VERSION} -i
    - name: Check for differences
      shell: bash
      run: |
        set -o pipefail
        echo "If you are reading this, you are probably looking at a failed"
        echo "Github Actions job. That means you pushed a file that did not"
        echo "conform to the formatting specified in .clang-format. That may"
        echo "be because you neglected to run 'git clang-format' or "
        echo "'clang-format' before committing, or that your version of"
        echo "clang-format has an incompatibility with the one on this"
        echo "machine, which is:"
        clang-format-${CLANG_VERSION} --version
        echo
        echo "To fix it, you can do one of two things:"
        echo "1. (The hard way): Download and apply the patch generated as an"
        echo "   artifact of this job to your repo, commit, and push."
        echo "2. (The easy way): Run "
        echo "   'git-clang-format --extensions c,cpp,h,cxx,ipp develop'"
        echo "   in your repo, commit, and push."
        git diff --exit-code | tee "${{ github.sha }}.patch"
    - name: Publish patch
      if: failure()
      uses: actions/upload-artifact@v2
      continue-on-error: true
      with:
        name: ${{ github.sha }}.patch
        if-no-files-found: ignore
        path: ${{ github.sha }}.patch

