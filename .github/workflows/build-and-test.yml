name: Build and test rippled
on: [push, pull_request]

env:
  CMAKE_EXTRA_ARGS: "-Dwerr=ON -Dwextra=ON"
#   NINJA_BUILD: true
#   CACHE_DIR: ${{ env.GITHUB_WORKSPACE }}/_cache
#   NIH_CACHE_ROOT: ${{ env.CACHE_DIR }}/nih_c
#   PARALLEL_TESTS: true
#   USE_CCACHE: true
#   CCACHE_BASEDIR: ${{ env.GITHUB_WORKSPACE }}
#   CCACHE_NOHASHDIR: true
#   CCACHE_DIR: ${{ env.CACHE_DIR }}/ccache

jobs:
  job:
    name: Build and test rippled
    continue-on-error: ${{ matrix.canfail }}
    runs-on: ubuntu-18.04
    # if: commit_message !~ /travis_run_/ OR commit_message =~ /travis_run_linux/
    container:
      image: docker://rippleci/rippled-ci-builder:2944b78d22db
    strategy:
      fail-fast: false
      matrix:
        # docker image has clang 7,8,9 & gcc 6,7,8,9
        CC: [ "gcc-8", "clang-8" ]
        BUILD_TYPE: [ Debug, Release ]
        canfail: [ false ]
        # https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions#jobsjob_idcontinue-on-error
    env:
      CC: ${{ matrix.CC }}
      BUILD_TYPE: ${{ matrix.BUILD_TYPE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
#       - name: cache
#         uses: actions/cache@v2
#         env:
#           cache-name: linux-cache
#         with:
#           path: ${{ env.CACHE_DIR }}
#           key:  ${{ runner.os }}-build-${{ env.cache-name }}
      - name: Dump-environment
        run: |
          env
          set | grep =
#       - name: cache stats before
#         run: ccache -s
      - name: Configure
        shell: bash
        #run: bin/ci/ubuntu/build-in-docker.sh
        run: |
          ls -l /usr/bin/{gcc,g++,clang}*
          export CXX=${CC/gcc/g++}
          export CXX=${CXX/clang/clang++}
          echo "Looking for CC ${CC}:"
          type -a ${CC}
          echo "Looking for CXX ${CXX}:"
          type -a ${CXX}
          mkdir build
          cd build
          cmake -DBoost_NO_BOOST_CMAKE=ON ${{ env.CMAKE_EXTRA_ARGS }} ..
      - name: Build rippled
        #run: bin/ci/ubuntu/build-in-docker.sh
        run: |
          echo Building with $( nproc ) jobs
          cmake --build build --target rippled --config ${{ env.BUILD_TYPE }} -j $( nproc )
      - name: Run tests
        run: |
          echo Running $( nproc ) parallel tests
          build/rippled --unittest --unittest-jobs=$( nproc )
#       - name: cache stats before
#         run: ccache -s
      - name: Debug output
        if: always()
        shell: bash
        run: |
          set -x
          cd build
          echo Home is ${HOME}
          echo PWD is $PWD
          ls -l
          pwd
          for file in CMakeOutput.log CMakeError.log
          do
            file="CMakeFiles/${file}"
            if [ -f ${file} ]
            then
              ls -l ${file}
              cat ${file}
            fi
          done
          ls -l /usr/bin
