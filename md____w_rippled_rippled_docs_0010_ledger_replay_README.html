<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rippled: Ledger Replay</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">rippled
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Ledger Replay </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><code>LedgerReplayer</code> is a new <code>Stoppable</code> for replaying ledgers. Patterned after two other <code>Stoppable</code>s under <code>JobQueue</code>&mdash;<code>InboundLedgers</code> and <code>InboundTransactions</code>&mdash;it acts like a factory for creating state-machine workers, and a network message demultiplexer for those workers. Think of these workers like asynchronous functions. Like functions, they each take a set of parameters. The <code>Stoppable</code> memoizes these functions. It maintains a table for each worker type, mapping sets of arguments to the worker currently working on that argument set. Whenever the <code>Stoppable</code> is asked to construct a worker, it first searches its table to see if there is an existing worker with the same or overlapping argument set. If one exists, then it is used. If not, then a new one is created, initialized, and added to the table.</p>
<p >For <code>LedgerReplayer</code>, there are three worker types: <code>LedgerReplayTask</code>, <code>SkipListAcquire</code>, and <code>LedgerDeltaAcquire</code>. Each is derived from <code>TimeoutCounter</code> to give it a timeout. For <code>LedgerReplayTask</code>, the parameter set is {reason, finish ledger ID, number of ledgers}. For <code>SkipListAcquire</code> and <code>LedgerDeltaAcquire</code>, there is just one parameter: a ledger ID.</p>
<p >Each <code>Stoppable</code> has an entry point. For <code>LedgerReplayer</code>, it is <code>replay</code>. <code>replay</code> creates two workers: a <code>LedgerReplayTask</code> and a <code>SkipListAcquire</code>. <code>LedgerDeltaAcquire</code>s are created in the callback for when the skip list returns.</p>
<p >For <code>SkipListAcquire</code> and <code>LedgerDeltaAcquire</code>, initialization fires off the underlying asynchronous network request and starts the timeout. The argument set identifying the worker is included in the network request, and copied to the network response. <code>SkipListAcquire</code> sends a request for a proof path for the skip list of the desired ledger. <code>LedgerDeltaAcquire</code> sends a request for the transaction set of the desired ledger.</p>
<p ><code>LedgerReplayer</code> is also a network message demultiplexer. When a response arrives for a request that was sent by a <code>SkipListAcquire</code> or <code>LedgerDeltaAcquire</code> worker, the <code>Peer</code> object knows to send it to the <code>LedgerReplayer</code>, which looks up the worker waiting for that response based on the identifying argument set included in the response.</p>
<p ><code>LedgerReplayTask</code> may ask <code>InboundLedgers</code> to send requests to acquire the start ledger, but there is no way to attach a callback or be notified when the <code>InboundLedger</code> worker completes. All the responses for its messages will be directed to <code>InboundLedgers</code>, not <code>LedgerReplayer</code>. Instead, <code>LedgerReplayTask</code> checks whether the start ledger has arrived every time its timeout expires.</p>
<p >Like a promise, each worker keeps track of whether it is pending (<code>!isDone()</code>) or whether it has resolved successfully (<code>complete_ == true</code>) or unsuccessfully (<code>failed_ == true</code>). It will never exist in both resolved states at once, nor will it return to a pending state after reaching a resolved state.</p>
<p >Like promises, some workers can accept continuations to be called when they reach a resolved state, or immediately if they are already resolved. <code>SkipListAcquire</code> and <code>LedgerDeltaAcquire</code> both accept continuations of a type specific to their payload, both via a method named <code>addDataCallback()</code>. Continuations cannot be removed explicitly, but they are held by <code><a class="elRef" href="http://en.cppreference.com/w/cpp/memory/weak_ptr.html">std::weak_ptr</a></code> so they can be removed implicitly.</p>
<p ><code>LedgerReplayTask</code> is simultaneously:</p>
<ol type="1">
<li>an asynchronous function,</li>
</ol>
<ol type="1">
<li>a continuation to one <code>SkipListAcquire</code> asynchronous function,</li>
</ol>
<ol type="1">
<li>a continuation to zero or more <code>LedgerDeltaAcquire</code> asynchronous functions, and</li>
</ol>
<ol type="1">
<li>a continuation to its own timeout.</li>
</ol>
<p >Each of these roles corresponds to different entry points:</p>
<ol type="1">
<li><code>init()</code></li>
</ol>
<ol type="1">
<li>the callback added to <code>SkipListAcquire</code>, which calls <code>updateSkipList(...)</code> or <code>cancel()</code></li>
</ol>
<ol type="1">
<li>the callback added to <code>LedgerDeltaAcquire</code>, which calls <code>deltaReady(...)</code> or <code>cancel()</code></li>
</ol>
<ol type="1">
<li><code>onTimer()</code></li>
</ol>
<p >Each of these entry points does something unique to that entry point. They either (a) transition <code>LedgerReplayTask</code> to a terminal failed resolved state (<code>cancel()</code> and <code>onTimer()</code>) or (b) try to make progress toward the successful resolved state. <code>init()</code> and <code>updateSkipList(...)</code> call <code>trigger()</code> while <code>deltaReady(...)</code> calls <code>tryAdvance()</code>. There's a similarity between this pattern and the way coroutines are implemented, where every yield saves the spot in the code where it left off and every resume jumps back to that spot.</p>
<h2><a class="anchor" id="autotoc_md93"></a>
Sequence Diagram</h2>
<p ><img src="./ledger_replay_sequence.png?raw=true" alt="Sequence diagram" title="A successful ledger replay" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md94"></a>
Class Diagram</h2>
<p ><img src="./ledger_replay_classes.png?raw=true" alt="Class diagram" title="Ledger replay classes" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
